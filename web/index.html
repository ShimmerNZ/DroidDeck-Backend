<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Droid Deck Control</title>
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
    <!-- Connection Overlay -->
    <div id="connectionOverlay" class="connection-overlay">
        <div class="connection-dialog">
            <h2>Connecting to Droid Deck</h2>
            <div class="spinner"></div>
            <p>Establishing connection to robot backend...</p>
            <button class="btn" onclick="connectWebSocket()">Retry Connection</button>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">DROID DECK</div>
            
            <!-- Mobile failsafe button  -->
            <button id="failsafeBtnMobile" 
                    class="failsafe-btn failsafe-active mobile-failsafe-btn" 
                    onclick="toggleFailsafe()"
                    title="Toggle Failsafe Mode">
                <span class="failsafe-icon">üõ°Ô∏è</span>
                <span class="failsafe-text">FAILSAFE</span>
            </button>
            
            <!-- Desktop stats  -->
            <div class="header-stats">
                <div class="stat-item">
                    <div class="status-dot" id="wsStatus"></div>
                    <span>Backend</span>
                </div>
                <div class="stat-item">
                    <div class="status-dot" id="controllerStatus"></div>
                    <span>Controller</span>
                </div>
                <div class="stat-item">
                    <div class="status-dot" id="systemStatus"></div>
                    <span>System</span>
                </div>
            </div>
        </div>
    </header>
    <div class="mobile-status-bar">
        <div class="stat-item">
            <div class="status-dot" id="wsStatusMobile"></div>
            <span>Backend</span>
        </div>
        <div class="stat-item">
            <div class="status-dot" id="controllerStatusMobile"></div>
            <span>Controller</span>
        </div>
        <div class="stat-item">
            <div class="status-dot" id="systemStatusMobile"></div>
            <span>System</span>
        </div>
    </div>


    <!-- Navigation -->
    <nav class="navigation">
        <div class="nav-container">
            <div class="nav-item active" onclick="showScreen('home')">Home</div>
            <div class="nav-item" onclick="showScreen('health')">Health</div>
            <div class="nav-item" onclick="showScreen('servo')">Servos</div>
            <div class="nav-item" onclick="showScreen('nema')">NEMA</div>
            <div class="nav-item" onclick="showScreen('controller')">Controller</div>
            <div class="nav-item" onclick="showScreen('scenes')">Scenes</div>
            <div class="nav-item" onclick="showScreen('settings')">Settings</div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-container">
        <!-- Home Screen -->
        <div id="homeScreen" class="screen active">
            <div class="glass-card">
                <div class="card-title">Scene Control Center</div>
                
                <div class="category-selector" id="categorySelector">
                    <div class="category-pills" id="categoryPills"></div>
                </div>
                
                <div class="scene-navigation-info">
                    <div class="nav-instruction">
                        <span class="nav-key">‚Üê‚Üí</span> Change Category | 
                        <span class="nav-key">‚Üë‚Üì</span> Select Scene | 
                        <span class="nav-key">Enter</span> Play Scene
                    </div>
                    <div class="scene-counter" id="sceneCounter">0 / 0</div>
                </div>
                
                <div class="scene-list-container" id="sceneListContainer">
                    <div class="scene-list" id="sceneList"></div>
                </div>
                
                <div class="scene-grid-container" id="sceneGridContainer" style="display: none;">
                    <div class="scene-grid" id="sceneGrid"></div>
                </div>
            </div>
            
            <div class="glass-card">
                <div class="card-title">Quick Actions</div>
                <div class="action-grid">
                    <button class="btn btn-danger" onclick="emergencyStop()">Emergency Stop</button>
                    <button class="btn btn-secondary" onclick="stopCurrentScene()">Stop Scene</button>
                    <button class="btn btn-secondary" onclick="refreshScenes()">Refresh Scenes</button>
                    <button class="btn btn-secondary" onclick="homeAllServos()">Home Servos</button>
                    <button class="btn btn-secondary" onclick="toggleSceneGrid()">Toggle Grid View</button>
                </div>
            </div>
        </div>

        <!-- Health Screen -->
        <div id="healthScreen" class="screen">
            <div class="glass-card">
                <div class="card-title">System Telemetry</div>
                <div class="health-grid" id="healthGrid">
                    <div class="health-metric">
                        <div class="health-value" id="cpuValue">--</div>
                        <div class="health-label">CPU Usage</div>
                        <div class="health-status" id="cpuStatus">Unknown</div>
                    </div>
                    <div class="health-metric">
                        <div class="health-value" id="memoryValue">--</div>
                        <div class="health-label">Memory Usage</div>
                        <div class="health-status" id="memoryStatus">Unknown</div>
                    </div>
                    <div class="health-metric">
                        <div class="health-value" id="batteryValue">--</div>
                        <div class="health-label">Battery Voltage</div>
                        <div class="health-status" id="batteryStatus">Unknown</div>
                    </div>
                    <div class="health-metric">
                        <div class="health-value" id="tempValue">--</div>
                        <div class="health-label">Temperature</div>
                        <div class="health-status" id="tempStatus">Unknown</div>
                    </div>
                </div>
            </div>

            <div class="glass-card">
                <div class="card-title">Hardware Status</div>
                <div class="control-grid" id="hardwareStatus">
                    <div class="control-panel">
                        <h4>Maestro Controllers</h4>
                        <div class="health-metric">
                            <div class="health-value" id="maestro1Status">--</div>
                            <div class="health-label">Maestro 1</div>
                        </div>
                        <div class="health-metric">
                            <div class="health-value" id="maestro2Status">--</div>
                            <div class="health-label">Maestro 2</div>
                        </div>
                    </div>
                    <div class="control-panel">
                        <h4>Audio & Systems</h4>
                        <div class="health-metric">
                            <div class="health-value" id="audioStatus">--</div>
                            <div class="health-label">Audio System</div>
                        </div>
                        <div class="health-metric">
                            <div class="health-value" id="networkStats">--</div>
                            <div class="health-label">Network</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Servo Screen -->
        <div id="servoScreen" class="screen">
            <div class="glass-card">
                <div class="card-title">Servo Control Interface</div>
                <div class="control-group">
                    <label class="control-label">
                        <span>Maestro Controller:</span>
                        <select id="maestroSelect" class="setting-input" onchange="switchMaestro()">
                            <option value="1">Maestro 1</option>
                            <option value="2">Maestro 2</option>
                        </select>
                    </label>
                </div>
                <div id="servoControls" class="control-grid"></div>
            </div>

            <div class="glass-card">
                <div class="card-title">Servo Actions</div>
                <div class="action-grid">
                    <button class="btn" onclick="getAllServoPositions()">Get All Positions</button>
                    <button class="btn btn-secondary" onclick="homeAllServos()">Home All Servos</button>
                    <button class="btn btn-secondary" onclick="sweepAllServos()">Sweep Test</button>
                    <button class="btn btn-secondary" onclick="stopAllServos()">Stop All Movement</button>
                </div>
            </div>
        </div>

        <!-- NEMA Screen -->
        <div id="nemaScreen" class="screen">
            <div class="nema-container">
                <!-- Left Panel: Configuration -->
                <div class="glass-card nema-config-panel">
                    <div class="card-title">NEMA Configuration</div>
                    
                    <!-- Physical Configuration -->
                    <div class="config-section">
                        <h3 class="config-section-title">Physical Setup</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Lead Screw Pitch (mm/rev):</label>
                                <input type="number" id="nemaLeadPitch" class="form-input" 
                                       value="8.0" min="1" max="20" step="0.5"
                                       onchange="updateNemaConfig('lead_screw_pitch', this.value)">
                            </div>
                            <div class="form-group">
                                <label>Max Travel (cm):</label>
                                <input type="number" id="nemaMaxTravel" class="form-input" 
                                       value="20.0" min="5" max="100" step="1"
                                       onchange="updateNemaConfig('max_travel_cm', this.value)">
                            </div>
                        </div>
                    </div>

                    <!-- Position Limits -->
                    <div class="config-section">
                        <h3 class="config-section-title">Position Limits</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Min Position (cm):</label>
                                <input type="number" id="nemaMinPos" class="form-input" 
                                       value="0.0" min="0" step="0.1"
                                       onchange="updateNemaPositionLimits()">
                            </div>
                            <div class="form-group">
                                <label>Max Position (cm):</label>
                                <input type="number" id="nemaMaxPos" class="form-input" 
                                       value="20.0" min="0" step="0.1"
                                       onchange="updateNemaPositionLimits()">
                            </div>
                        </div>
                    </div>

                    <!-- Speed Configuration -->
                    <div class="config-section">
                        <h3 class="config-section-title">Speed & Acceleration</h3>
                        
                        <div class="form-group">
                            <label>Homing Speed: <span id="nemaHomingSpeedValue">400</span> steps/s</label>
                            <input type="range" id="nemaHomingSpeed" class="form-range"
                                   min="100" max="1000" value="400" step="50"
                                   oninput="updateNemaSpeedDisplay('nemaHomingSpeedValue', this.value)"
                                   onchange="updateNemaConfig('homing_speed', this.value)">
                        </div>

                        <div class="form-group">
                            <label>Normal Speed: <span id="nemaNormalSpeedValue">1000</span> steps/s</label>
                            <input type="range" id="nemaNormalSpeed" class="form-range"
                                   min="200" max="2000" value="1000" step="50"
                                   oninput="updateNemaSpeedDisplay('nemaNormalSpeedValue', this.value)"
                                   onchange="updateNemaConfig('normal_speed', this.value)">
                        </div>

                        <div class="form-group">
                            <label>Max Speed: <span id="nemaMaxSpeedValue">1200</span> steps/s</label>
                            <input type="range" id="nemaMaxSpeed" class="form-range"
                                   min="500" max="3000" value="1200" step="100"
                                   oninput="updateNemaSpeedDisplay('nemaMaxSpeedValue', this.value)"
                                   onchange="updateNemaConfig('max_speed', this.value)">
                        </div>

                        <div class="form-group">
                            <label>Acceleration: <span id="nemaAccelValue">800</span> steps/s¬≤</label>
                            <input type="range" id="nemaAccel" class="form-range"
                                   min="100" max="2000" value="800" step="50"
                                   oninput="updateNemaSpeedDisplay('nemaAccelValue', this.value)"
                                   onchange="updateNemaConfig('acceleration', this.value)">
                        </div>
                    </div>

                    <!-- Save Configuration -->
                    <div class="action-grid">
                        <button class="btn" onclick="saveNemaConfig()">üíæ Save Config</button>
                        <button class="btn btn-secondary" onclick="resetNemaConfig()">‚Ü∫ Reset to Defaults</button>
                    </div>
                </div>

                <!-- Right Panel: Control -->
                <div class="glass-card nema-control-panel">
                    <div class="card-title">NEMA Control</div>

                    <!-- Status Display -->
                    <div class="nema-status-display">
                        <div class="status-item">
                            <span class="status-label">State:</span>
                            <span class="status-value" id="nemaState">Unknown</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Position:</span>
                            <span class="status-value" id="nemaCurrentPos">--</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Homed:</span>
                            <span class="status-indicator" id="nemaHomedIndicator">‚ùå</span>
                        </div>
                        <div class="status-item">
                            <span class="status-label">Enabled:</span>
                            <span class="status-indicator" id="nemaEnabledIndicator">‚ùå</span>
                        </div>
                    </div>

                    <!-- Position Control -->
                    <div class="nema-position-control">
                        <div class="position-display-large" id="nemaPositionDisplay">
                            0.0 cm
                        </div>

                        <label class="control-label">Target Position</label>
                        <div class="position-slider-container">
                            <input type="range" id="nemaPositionSlider" class="nema-position-slider"
                                   min="0" max="200" value="0" step="1"
                                   oninput="updateNemaPositionDisplay()"
                                   onchange="sendNemaPosition()">
                            <div class="slider-labels">
                                <span id="nemaSliderMin">0.0</span>
                                <span id="nemaSliderMax">20.0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Control Buttons -->
                    <div class="nema-controls">
                        <button class="btn btn-success" onclick="toggleNemaEnable()" id="nemaEnableBtn">
                            ‚ö° ENABLE
                        </button>
                        
                        <button class="btn" onclick="homeNema()">
                            üè† HOME
                        </button>

                        <button class="btn" onclick="toggleNemaSweep()" id="nemaSweepBtn">
                            ‚ñ∂Ô∏è TEST SWEEP
                        </button>

                        <button class="btn btn-danger" onclick="stopNema()">
                            ‚èπÔ∏è STOP
                        </button>
                    </div>

                    <!-- Quick Position Buttons -->
                    <div class="quick-positions">
                        <h4>Quick Positions</h4>
                        <div class="quick-pos-grid">
                            <button class="btn btn-small" onclick="moveNemaToPosition(0)">Min (0cm)</button>
                            <button class="btn btn-small" onclick="moveNemaToPosition(5)">5cm</button>
                            <button class="btn btn-small" onclick="moveNemaToPosition(10)">10cm</button>
                            <button class="btn btn-small" onclick="moveNemaToPosition(15)">15cm</button>
                            <button class="btn btn-small" onclick="moveNemaToPosition(20)">Max (20cm)</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Controller Screen -->
        <div id="controllerScreen" class="screen">
            <div class="glass-card">
                <div class="card-title">Controller Management</div>
                <div class="control-grid">
                    <div class="control-panel">
                        <h4>Controller Status</h4>
                        <div class="nema-status" id="controllerStatusDisplay">
                            <div class="nema-indicator" id="controllerIndicator"></div>
                            <div>
                                <div><strong id="controllerName">No Controller Connected</strong></div>
                                <div id="controllerInfo">Connect a controller to the backend</div>
                            </div>
                        </div>
                        <div class="action-grid">
                            <button class="btn" onclick="requestControllerInfo()">Refresh Status</button>
                            <button class="btn btn-secondary" onclick="startCalibration()">Start Calibration</button>
                            <button class="btn btn-secondary" onclick="stopCalibration()">Stop Calibration</button>
                        </div>
                    </div>

                    <div class="control-panel">
                        <h4>Navigation Test</h4>
                        <p>Use your controller's D-pad to test navigation:</p>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; max-width: 200px; margin: 1rem 0;">
                            <div></div>
                            <button class="btn btn-small" id="navUp">‚Üë</button>
                            <div></div>
                            <button class="btn btn-small" id="navLeft">‚Üê</button>
                            <button class="btn btn-small" id="navSelect">SEL</button>
                            <button class="btn btn-small" id="navRight">‚Üí</button>
                            <div></div>
                            <button class="btn btn-small" id="navDown">‚Üì</button>
                            <div></div>
                        </div>
                        <div id="lastNavigation">Last navigation: None</div>
                    </div>
                </div>
            </div>

            <div class="glass-card">
                <div class="card-title">Controller Configuration</div>
                <div class="control-grid">
                    <div class="control-panel">
                        <h4>Calibration Status</h4>
                        <div id="calibrationStatus">
                            <p>Controller calibration status will appear here</p>
                        </div>
                        <div class="action-grid">
                            <button class="btn" onclick="saveControllerConfig()">Save Config</button>
                            <button class="btn btn-secondary" onclick="loadControllerConfig()">Load Config</button>
                            <button class="btn btn-secondary" onclick="resetCalibration()">Reset Calibration</button>
                        </div>
                    </div>

                    <div class="control-panel">
                        <h4>Input Mapping</h4>
                        <div class="mapping-list" id="mappingList"></div>
                        <div class="action-grid">
                            <button class="btn" onclick="addNewMapping()">Add Mapping</button>
                            <button class="btn btn-secondary" onclick="clearAllMappings()">Clear All</button>
                            <button class="btn btn-secondary" onclick="loadDefaultMappings()">Load Defaults</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="glass-card">
                <div class="card-title">Mapping Editor</div>
                <div class="mapping-editor" id="mappingEditor" style="display: none;">
                    <div class="control-group">
                        <label class="control-label">
                            <span>Controller Input:</span>
                            <select id="mappingInput" class="setting-input">
                                <option value="">Select Input</option>
                                <option value="button_a">Button A</option>
                                <option value="button_b">Button B</option>
                                <option value="button_x">Button X</option>
                                <option value="button_y">Button Y</option>
                                <option value="shoulder_left">Left Shoulder</option>
                                <option value="shoulder_right">Right Shoulder</option>
                                <option value="left_trigger">Left Trigger</option>
                                <option value="right_trigger">Right Trigger</option>
                                <option value="left_stick_x">Left Stick X</option>
                                <option value="left_stick_y">Left Stick Y</option>
                                <option value="right_stick_x">Right Stick X</option>
                                <option value="right_stick_y">Right Stick Y</option>
                                <option value="dpad_up">D-Pad Up</option>
                                <option value="dpad_down">D-Pad Down</option>
                                <option value="dpad_left">D-Pad Left</option>
                                <option value="dpad_right">D-Pad Right</option>
                            </select>
                        </label>
                    </div>

                    <div class="control-group">
                        <label class="control-label">
                            <span>Behavior Type:</span>
                            <select id="mappingBehavior" class="setting-input" onchange="updateMappingOptions()">
                                <option value="">Select Behavior</option>
                                <option value="direct_servo">Direct Servo Control</option>
                                <option value="joystick_pair">Joystick Pair</option>
                                <option value="differential_tracks">Differential Tracks</option>
                                <option value="scene_trigger">Scene Trigger</option>
                                <option value="toggle_scenes">Toggle Scenes</option>
                                <option value="nema_stepper">NEMA Stepper</option>
                                <option value="system_control">System Control</option>
                            </select>
                        </label>
                    </div>

                    <div id="mappingOptions"></div>

                    <div class="action-grid">
                        <button class="btn" onclick="saveMappingEdit()">Save Mapping</button>
                        <button class="btn btn-secondary" onclick="cancelMappingEdit()">Cancel</button>
                        <button class="btn btn-danger" onclick="deleteMappingEdit()">Delete</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scenes Screen -->
        <div id="scenesScreen" class="screen">
            <div class="glass-card">
                <div class="card-title">Scene Management</div>
                <div class="action-grid" style="margin-bottom: 2rem;">
                    <button class="btn" onclick="loadScenes()">Reload Scenes</button>
                    <button class="btn btn-secondary" onclick="stopCurrentScene()">Stop Current Scene</button>
                    <button class="btn btn-secondary" onclick="importScenesFromBackend()">Import Scenes</button>
                    <button class="btn btn-secondary" onclick="exportSceneConfig()">Export Config</button>
                </div>
                <div id="scenesList" class="control-grid"></div>
            </div>
        </div>

        <!-- Settings Screen -->
        <div id="settingsScreen" class="screen">
            <div class="glass-card">
                <div class="card-title">Connection Settings</div>
                <div class="settings-grid">
                    <div class="setting-item">
                        <label>Backend WebSocket URL:</label>
                        <input type="text" class="setting-input" id="wsUrl" value="ws://10.1.1.230:8766">
                    </div>
                    <div class="setting-item">
                        <label>Auto Reconnect:</label>
                        <input type="checkbox" id="autoReconnect" checked>
                    </div>
                    <div class="setting-item">
                        <label>Reconnect Interval (seconds):</label>
                        <input type="number" class="setting-input" id="reconnectInterval" value="5" min="1" max="30">
                    </div>
                </div>
                <div class="action-grid">
                    <button class="btn" onclick="saveSettings()">Save Settings</button>
                    <button class="btn btn-secondary" onclick="testConnection()">Test Connection</button>
                    <button class="btn btn-secondary" onclick="resetToDefaults()">Reset to Defaults</button>
                </div>
            </div>

            <div class="glass-card">
                <div class="card-title">Interface Settings</div>
                <div class="settings-grid">
                    <div class="setting-item">
                        <label>Theme:</label>
                        <select class="setting-input" id="themeSelect" onchange="changeTheme()">
                            <option value="modern">Modern Dark</option>
                            <option value="wall-e">WALL-E Classic</option>
                            <option value="star-wars">Star Wars</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label>Update Interval (ms):</label>
                        <input type="number" class="setting-input" id="updateInterval" value="5000" min="1000" max="30000" step="1000">
                    </div>
                    <div class="setting-item">
                        <label>Enable Animations:</label>
                        <input type="checkbox" id="enableAnimations" checked>
                    </div>
                </div>
            </div>

            <div class="glass-card">
                <div class="card-title">System Information</div>
                <div id="systemInfo">
                    <div class="setting-item">
                        <label>Version:</label>
                        <span>Droid Deck Web v2.0</span>
                    </div>
                    <div class="setting-item">
                        <label>Last Update:</label>
                        <span id="lastUpdate">--</span>
                    </div>
                    <div class="setting-item">
                        <label>Connection Status:</label>
                        <span id="connectionInfo">Disconnected</span>
                    </div>
                    <div class="setting-item">
                        <label>Active Clients:</label>
                        <span id="activeClients">0</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast Notifications -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.2/socket.io.js"></script>
    <script src="/static/js/app-state.js"></script>
    <script src="/static/js/socket-handler.js"></script>
    <script src="/static/js/ui-functions.js"></script>
    <script src="/static/js/scene-editor.js"></script>
</body>
</html>